# Next.js勉強会
# アジェンダ

1. 自己紹介
2. Next.jsとは？（25分くらい）
3. Next.jsを動かしてみる（10分くらい）
4. ちょっとしたアプリを作ってみる（30分くらい）
5. 技術的設計において気をつけること（5〜10分くらい）
6. 質疑応答（∞）

# 自己紹介

- 福島大稀　（Daiki Fukushima）
    - ざっくりとGENIEEでの経歴
        - GENIEE Chamo 何でもエンジニア（インターン〜1年目）
        - GENIEE CHAT report開発おじさん兼管理者（1年目2月〜2年目）
        - 株式会社CATS（GENIEE子会社） CATSプロダクトマネージャ（2年目1月〜今）
    - CTOです（Chief Test Officer）
    - ちなみに心理化学科出身でバリバリの文系であります
    - 休日はスタジアムに行ってサッカー見たり、フットサルしに行ったり、自転車でサイクリングロード爆走したりしてます

![IMG_2571.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/1e5b1be9-e798-42f9-bf94-abbeae12ec6b/1d551ef7-5ee2-40da-872e-01c9fa60808e/IMG_2571.jpeg)

![IMG_2891.jpeg](https://prod-files-secure.s3.us-west-2.amazonaws.com/1e5b1be9-e798-42f9-bf94-abbeae12ec6b/42403705-8e0d-4ae3-97ad-4489767194a4/IMG_2891.jpeg)

# Next.jsとは？

UI構築ライブラリReactをベースに作られたフロントエンドフレームワーク。

Reactベースなので宣言的UI構築によるコーディングを主軸とし、SSRやSSG、CSRを柔軟に使い分けることが可能なフレームワーク。

## Next.jsの特徴

Next.jsの特徴としては（ドキュメント抜粋）

https://nextjs.org/docs

1. ルーティングが非常に容易
    1. PageRouter
    2. AppRouter
2. 柔軟なレンダリング
    1. SSR
    2. SSG
    3. CSR
3. DataFetching
    1. server component
    2. `fetch`API
4. TypeScript対応

### 特に取り上げられるものとして

ルーティング、レンダリング、DataFetchingが挙げられる

独自のデータライフサイクル（cacheのライフサイクル）を持っている

### ルーティングについて

Next.jsには二種類のルーティング方法があります

1. PageRouter
    
    Next.js最初期から存在しているルーティングシステム
    
    1. `pages`ディレクトリ配下にルートとなる `App.tsx or App.jsx`を配置することでルーティングがスタートします
    2. ルーティングネストを作る際はpagesのは以下にディレクトリを作り表示させるページコンポーネントを作成します
2. AppRouter（今回のハンズオンはこちらで進めます）
    1. Next.js version13リリース後からベータ版としてリリースされたルーティングシステムです。
        1. 最近13のどこかでstableになりました、最近だとコマンドでNext.jsのプロジェクトを作るとこちらのルーティングで作成されます
    2. 基本思想としてはSSRを主軸としています
    3. ルーティングとしては `app`ディレクトリ配下に表示させるページである `page.tsx`を配置する
        1. 基本思想としてSPAを考えており同一ディレクトリ上に複数の `page.tsx`を配置することはできません
    4. ルーティングネストを作る場合はこちらもPageRouterと同じく配下にディレクトリを作成することでルーティングが可能になります
        1. しかし注意なのはディレクトリ名がそのままパスになるので命名に気をつけなければならない
    5. Nested Layoutが基本的な思想としてあり、メモ化等をうまいこと使えば画面の遷移や切り替え等で必要な部分のみの再レンダーで済むためパフォーマンスが良い

### レンダリング

フロントエンドにおいてレンダリングは切り離せない問題です

`ServerSideRendering(SSR)` , `StaticSiteGeneration(SSG)` 

よく挙げられるのは上記の2種でしょうか

その他にもCSR、ISRなどがありますが今回は割愛します

気になる方は調べてみましょう

Next.jsでは基本的にはSSRで動くのですが公式さん的にはSSGを推奨しています

- SSR
    - 命名通りでサーバーサイドにリクエストを送りJavaScriptを実行しその結果のレンダリングで得られたHTMLをクライアントサイドへ変換するレンダリング方法です
    - 初期ロードが非常に早くSEO対策に非常に向いています
        - 初期ページに関してはプロジェクトのビルド時に作られた静的ファイルをクライアントに返還するだけなので高速になると考えられる
    - しかしリクエスト事にレンダリングが実行されるのでサーバースペックに依存してしまう
- SSG
    - 静的ファイルを配信し続ける
    - Next.jsに置いてはビルド時にデータの取得やレンダリングを行い静的なファイルを作成する
    - 非常に高速なページ表示が可能になる
    - しかし、データのリアルタイム性には少々かけてしまう
        - データが最新になるたびにアプリケーションをビルドし直さなければならない

現状複数のレンダリングを場所によって使い分けることが可能なライブラリやフレームワークとしてはNext.js、Nuxt.js、Svelteでしょうか

（Gatsybyは部分的にのみ対応しているので対象外）

この中でNext.jsはReactとの親和性が非常に高いため人気です

Nuxt.jsはVue.jsという別フレームワークのフレームワークで、vue.js version3以降でプロジェクト作成するとバンドルサイズが非常に小さく、純粋なDOMにアクセスしJavaScriptで処理を行い結果を返すというpureJSぽい書き方ができるのが強みです。

### DataFetching & cache

- DataFetching
    
    hooksではないのですがNext.jsが用意している `fetchAPI`を利用して外部からデータを取得することがベーシックな実装になります。外部ライブラリのaxiosを使用したり、 `async` `await` の利用も考えられますがNext.jsではfetchAPIが推奨です。
    
    Next.jsでは様々なレンダリング方法や最適化、cache flowに対応するためにdata fetching周りも特徴的です
    
- cache
    
    Next.jsには種類のcacheが存在します。そして、それぞれの役割やデータのFlowについてはイカの画像に示されています
    
    [caching-overview.avif](https://prod-files-secure.s3.us-west-2.amazonaws.com/1e5b1be9-e798-42f9-bf94-abbeae12ec6b/85ad3031-be27-4eab-b160-7cebed2a2527/caching-overview.avif)
    
    Next.jsでは各層にて細かくデータをcacheできるようになっています。
    
    - Data Cache
        - fetchしたデータはすべてここに保存されます
        - 同一のリクエストに関してはここから結果を返すようになります
        - またcacheの保存期限が無期限
        - 動作としてはリクエスト→cacheがあるかの確認→あればDataCacheを返還（動作終了）→fetch関数を実行→結果をDataCacheにセット→クライアントに返還
    - Full Route Cache
        - ビルドや再検証（再計算）、レンダリング等でサーバーサイドで生成されたRSC payloadやHTMLが保存されます
        - Data Cache同様永続的に保存されます
        - つまるところメモ化されたコンポーネントが保存されているuseMemoなどの再検証が走りコンポーネントの更新が怒らなかった場合Full Route Cacheの情報が参照される
        - しかし動的ルートに関してはリクエストと同時レンダリングされるのでCacheへの保存は怒らない
    - Route Cache
        - クライアントのCache
        - リロードすると死ぬ
    - Request Memoization
        - Server
        - また保存期間はレンダリング中のみ

## AppRouter

### Layout.tsx

各ディレクトリ事に作ることがかのうでappディレクトリ直下にあるLayoutはすべてのPageに適用されるものになる。また、`app/Layout.tsx`はAppRouterにおける最も親の位置に存在するJSXファイルになります。

### Template.tsx

Layout.tsxと動作は非常によく似ているが決定的に違う特徴があります。

Layout.tsxはページ遷移に対してステートを維持した状態で遷移します。

それに対してtemplate.tsxがあることでページ遷移することで新しいステートを作成する。
したがってDOMが再同期される。

ページ遷移時にアニメーションを始めとした動作を動かしたい時や各ページごとにロンギングを走らせる等がある場合はtemplateを使うとよいでしょう。

### Page.tsx

AppRouterではページを表示する際はこのPage.tsxがないと表示がされない。

Page.tsx内で様々なUIコンポーネントを呼び出しUIを組み上げることになる。

また小ページを作る際にディレクトリを作るとありますがその際にディレクトリにPage.tsxがなければページは表示されません。

## Link

LinkAPIはNext.jsのルーティングが容易にできる要因を作ってくれたものの一つです。

サイト内リンクを始めとしたルーティングNext.jsが用意しているルーティングコンポーネントです。

Linkのpropsで遷移先のパスを受取そのまま受け取ったパスへと遷移することができます

## fetch

こちらはJavaScriptのAPIである `fetch`とは少々異なります

データフェッチングに関してはMDNと同じなのですがそのフェッチにプラスしてData Cacheとの対話による動作の制御を可能にします

またキャッシュへの保存期間の設定等も可能にします

## Next.jsを動かしてみる

今回はAppRouterを使って見ようと思います。

Next.jsは公式がセットアップのCLIを用意しているのでそちらを使用しましょう

```jsx
$ npx create-next-app --ts --example with-turbopack
$ yarn create next-app --ts --example with-turbopack
$ pnpm create next-app --ts --example with-turbopack
-----------------------------------------------------
$ npm run dev // yarn dev or pnpm dev
```

## プロダクトを作ってみよう

よくあるものですがブログを作ってみましょう

要件について考えてみましょう！

どんな機能が必要でしょうか？

- 必要になりそうな機能
    - トップページ
    - 自己紹介ページ
    - ブログ一覧
    - ブログ詳細
- 画面構成
    - トップ画面、ダッシュボードポイ画面
    - ブログリスト画面
    - 詳細画面
- ユーザー管理に関して
    
    そもそも今回は個人利用のウェブアプリなので必要ないがSNSのような多くのユーザーと共有するようなアプリなら必要
    
    今回は作りませんが挑戦してみたい人は個人で挑戦してみましょう
    
- DB
    
    今回は記事自体はマークダウンファイルで管理しますが本来であればDBにファイルもしくはスキーマを定義してコンテンツを格納することが考えられます
    

### 今回これ全てをやるのは少々酷なので

- Topページから新しく別のページに移動してみる
- とりあえずLinkAPIを使ってルーティングをしてみる
- Layoutを使ってSPAのレイアウトを作ってみる
- （ダイナミックルーティングを触ってみる）

DBの作成やそれとフロントをつなぐAPI等は自分の好きな言語でやってみてください

### UIイメージの作成も要件定義に含まれます！

UIはエンジニアでいい感じにしておいて〜という会社や事業部もあるでしょうが基本的にはUIイメージの作成も要件定義の一つになります。

PdMやBD、デザイナーからこのようなデザインにしたいと依頼が来るでしょうがそれをすべて受け入れる必要もありません

PdMたちとより最善かつ実現可能性の高いデザインへとアップデートしましょう

### ライブラリ選定

今回はNext.jsのハンズオンということでNext.js, React.jsは必須ですが他に何が必要でしょうか？

フォーム入力に関して自分たちで一から全て実装するのもいいでしょうしかしライブラリに頼るというのもまた一つの手段です。

入力された値に対してその値が正常な値であるのかのバリデーションチェックも必要でしょう。

などを考えて実際にはライブラリ選定を次に行いましょう。

# 技術的な設計や開発時に気をつけること

色々話してきましたが実際の開発において更に気をつけるべきことが山のようにあります。

例えば

- コーディング規約
    - linter
    - formatter
    

- テスト
    - ユニットテスト
    - 結合テスト
    - e2eテスト
    

- 設計手法
    - ドメイン駆動
    - CleanArchitecture
    - MVC

特にNext.js（React.js）のようにコンポーネントを作成してそれらを組み合わせてUIを構築するフレームワークにおいてはコンポーネントを切る粒度、共通化できる関数をカスタムhooksにする。

カスタムコンポーネントや共通関数、カスタムhooksなどをどこでも使えるようにジェネリクスを意識するなど気をつけることが非常に多いです
